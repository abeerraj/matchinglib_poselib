#include "descriptor-BOLD/bold.hpp"
#include <opencv2/opencv.hpp>
#include <fstream>

int getLearnedData(int idx);

/* load tests and init 2 rotations
   for fast affine aprox. (example -20,20) */
BOLD::BOLD(void)
{
  bin_tests = (int**) malloc(NROTS * sizeof(int *));
  for (int i = 0; i < NROTS; i++){
    bin_tests[i] = (int*)malloc(NTESTS*2 * sizeof(int));
  }
  /*std::ifstream file;
  file.open("bold.descr");*/
  /* read original tests and set them to rotation 0 */
  for(int j = 0; j < NTESTS*2; j++ )
    {
      //file >> bin_tests[0][j];
	  bin_tests[0][j] = getLearnedData(j);
    }	
  //file.close();
  rotations[0] = 20; 
  rotations[1] = -20;
  /* compute the rotations offline */
  for (int i = 0; i < NTESTS*2; i+=2) {
    int x1 = bin_tests[0][i] % 32;
    int y1 = bin_tests[0][i] / 32;
    int x2 = bin_tests[0][i+1] % 32;
    int y2 = bin_tests[0][i+1] / 32;
    for (int a = 1; a < NROTS; a++) {
      float angdeg = rotations[a-1];
      float angle = angdeg*(float)(CV_PI/180.f);
      float ca = (float)cos(angle);
      float sa = (float)sin(angle);
      int rotx1 = (x1-15)*ca - (y1-15)*sa + 16;
      int roty1 = (x1-15)*sa + (y1-15)*ca + 16;
      int rotx2 = (x2-15)*ca - (y2-15)*sa + 16;
      int roty2 = (x2-15)*sa + (y2-15)*ca + 16;
      bin_tests[a][i] = rotx1 + 32*roty1;
      bin_tests[a][i+1] = rotx2 + 32*roty2;
    }    
  }
}

BOLD::~BOLD(void)
{
  /* free the tests */
  for (int i = 0; i < NROTS; i++){
    free(bin_tests[i]);
  }
  free(bin_tests);
}

void BOLD::compute_patch(cv::Mat img, cv::Mat& descr,cv::Mat& masks) 
{
  /* init cv mats */
  int nkeypoints = 1;
  if(descr.empty())
	descr.create(nkeypoints, DIMS/8, CV_8U);
  if(masks.empty())
	masks.create(nkeypoints, DIMS/8, CV_8U);

  /* apply box filter */  
  cv::Mat patch;
  boxFilter(img, patch, img.depth(), cv::Size(5,5),
	    cv::Point(-1,-1), true, cv::BORDER_REFLECT);

  /* get test and mask results  */    
  int k =0;
  uchar* dsc = descr.ptr<uchar>(k);
  uchar* msk = masks.ptr<uchar>(k);
  uchar *smoothed = patch.data;
  int* tests = bin_tests[0];
  int* r0 = bin_tests[1];
  int* r1 = bin_tests[2];
  unsigned int val = 0;
  unsigned int var = 0;
  int idx = 0;
  int j=0;
  int bit;
  int tdes,tvar;
  for (int i = 0; i < DIMS; i++,j+=2){
    bit = i%8;
    int temp_var=0;
    tdes = (smoothed[tests[j]] < smoothed[tests[j+1]]);    
    temp_var += (smoothed[r0[j]] < smoothed[r0[j+1]])^tdes;
    temp_var += (smoothed[r1[j]] < smoothed[r1[j+1]])^tdes;
    /* tvar-> 0 not stable --------  tvar-> 1 stable */
    tvar = (temp_var == 0) ;
    if (bit==0)
      {
	val = tdes;
	var = tvar;
      } 
    else
      {
	val |= tdes << bit;
	var |= tvar << bit;
      }
    if (bit==7)
      {
	dsc[idx] = val;
	msk[idx] = var;
	val = 0;
	var = 0;
	idx++;
      }
  }
}

/* masked distance  */  
//int BOLD::hampopmaskedLR(uchar *a,uchar *ma,uchar *b,uchar *mb)
//{
//  int distL = 0;
//  int distR = 0;
//  int nL = 0;
//  int nR = 0;
//  for (int i = 0; i < 64; i++) {
//    int axorb = a[i] ^ b[i];
//    int xormaskedL = axorb & ma[i]  ;
//    int xormaskedR = axorb & mb[i]  ;
//    nL += ma[i];
//    nR += mb[i];    
//    distL += __builtin_popcount(xormaskedL);    
//    distR += __builtin_popcount(xormaskedR);    
//  }
//  float n = nL + nR;
//  float wL = nL / n;
//  float wR = nR / n;
//  return distL*wL + distR*wR;
//}
//
///* hamming distance  */  
//int BOLD::hampop(uchar *a,uchar *b)
//{
//  int distL = 0;
//  for (int i = 0; i < 64; i++) {
//    int axorb = a[i] ^ b[i];
//    distL += __builtin_popcount(axorb);    
//  }
//  return distL;
//}

int getLearnedData(int idx)
{
	static int data[] = {
		209, 918,
		209, 117,
		308, 625,
		777, 201,
		262, 492,
		220, 303,
		424, 486,
		155, 922,
		201, 331,
		171, 493,
		495, 890,
		536, 626,
		120, 118,
		581, 555,
		919, 122,
		891, 463,
		305, 279,
		689, 696,
		839, 163,
		740, 232,
		852, 315,
		567, 406,
		344, 506,
		429, 843,
		824, 272,
		645, 679,
		329, 681,
		303, 559,
		443, 275,
		557, 621,
		615, 392,
		208, 335,
		729, 790,
		122, 636,
		202, 901,
		120, 655,
		316, 123,
		411, 313,
		626, 373,
		115, 719,
		817, 210,
		485, 614,
		572, 885,
		235, 779,
		101, 299,
		915, 888,
		887, 915,
		491, 523,
		687, 495,
		291, 231,
		114, 700,
		656, 336,
		624, 245,
		644, 293,
		134, 808,
		369, 723,
		700, 922,
		399, 252,
		688, 820,
		763, 251,
		840, 835,
		131, 835,
		856, 604,
		217, 884,
		464, 400,
		919, 859,
		200, 163,
		282, 315,
		150, 219,
		530, 534,
		806, 683,
		682, 743,
		426, 422,
		655, 848,
		234, 136,
		307, 633,
		592, 496,
		451, 515,
		404, 566,
		358, 548,
		803, 777,
		784, 915,
		789, 560,
		711, 579,
		781, 109,
		405, 403,
		456, 489,
		763, 849,
		163, 201,
		440, 375,
		307, 409,
		727, 689,
		174, 846,
		648, 452,
		389, 360,
		588, 230,
		662, 440,
		775, 774,
		571, 666,
		400, 656,
		345, 664,
		806, 739,
		296, 709,
		474, 725,
		915, 916,
		433, 307,
		565, 563,
		877, 717,
		668, 117,
		508, 218,
		396, 233,
		180, 412,
		463, 527,
		434, 406,
		379, 528,
		380, 823,
		790, 247,
		283, 214,
		684, 905,
		913, 816,
		623, 655,
		329, 293,
		655, 623,
		683, 588,
		622, 430,
		751, 399,
		912, 207,
		903, 267,
		292, 713,
		621, 493,
		174, 110,
		661, 371,
		245, 791,
		786, 539,
		662, 631,
		902, 871,
		456, 583,
		435, 498,
		186, 283,
		237, 301,
		884, 720,
		273, 242,
		515, 579,
		617, 491,
		881, 151,
		816, 655,
		299, 652,
		654, 111,
		451, 357,
		679, 680,
		587, 362,
		259, 708,
		245, 337,
		396, 708,
		843, 397,
		101, 102,
		506, 569,
		750, 911,
		852, 729,
		412, 348,
		146, 156,
		104, 170,
		147, 150,
		508, 859,
		495, 178,
		493, 104,
		264, 419,
		398, 750,
		522, 456,
		658, 691,
		113, 881,
		108, 717,
		123, 220,
		365, 685,
		810, 872,
		227, 131,
		227, 228,
		310, 311,
		468, 595,
		343, 310,
		796, 918,
		547, 452,
		278, 243,
		815, 795,
		412, 668,
		249, 184,
		367, 271,
		633, 433,
		700, 636,
		331, 460,
		841, 810,
		869, 905,
		403, 469,
		664, 571,
		889, 762,
		236, 139,
		754, 336,
		344, 408,
		305, 688,
		685, 717,
		717, 685,
		923, 916,
		331, 744,
		603, 380,
		708, 515,
		498, 661,
		260, 387,
		707, 836,
		727, 698,
		266, 233,
		220, 348,
		118, 113,
		549, 388,
		291, 259,
		787, 820,
		121, 217,
		148, 215,
		759, 822,
		804, 901,
		515, 265,
		837, 868,
		775, 869,
		629, 533,
		620, 364,
		778, 684,
		793, 857,
		612, 741,
		851, 849,
		844, 907,
		182, 150,
		170, 202,
		675, 676,
		323, 324,
		411, 537,
		711, 390,
		186, 123,
		470, 340,
		822, 856,
		329, 556,
		778, 323,
		243, 121,
		440, 566,
		742, 775,
		899, 140,
		230, 100,
		884, 821,
		793, 729,
		503, 632,
		627, 529,
		851, 916,
		822, 788,
		100, 579,
		133, 292,
		344, 346,
		419, 166,
		744, 807,
		112, 113,
		919, 823,
		858, 443,
		697, 825,
		105, 136,
		790, 664,
		899, 804,
		567, 410,
		171, 236,
		388, 837,
		529, 403,
		167, 137,
		824, 890,
		393, 328,
		110, 237,
		228, 294,
		409, 215,
		867, 325,
		430, 301,
		598, 630,
		755, 724,
		236, 99,
		409, 314,
		561, 337,
		739, 493,
		731, 729,
		662, 725,
		146, 175,
		294, 231,
		483, 584,
		183, 345,
		123, 110,
		304, 336,
		409, 406,
		634, 731,
		744, 394,
		808, 841,
		374, 437,
		296, 327,
		139, 137,
		280, 339,
		486, 485,
		843, 812,
		526, 751,
		379, 476,
		700, 622,
		213, 115,
		123, 245,
		280, 796,
		827, 757,
		615, 646,
		617, 519,
		238, 114,
		611, 904,
		108, 171,
		921, 924,
		358, 520,
		711, 646,
		565, 568,
		871, 677,
		265, 874,
		484, 259,
		408, 785,
		104, 231,
		677, 739,
		789, 757,
		324, 453,
		902, 743,
		875, 198,
		239, 462,
		371, 401,
		602, 631,
		593, 721,
		137, 644,
		433, 476,
		892, 795,
		892, 856,
		586, 585,
		277, 406,
		696, 535,
		761, 664,
		874, 807,
		722, 116,
		724, 756,
		326, 197,
		626, 532,
		105, 813,
		540, 750,
		277, 245,
		581, 580,
		709, 678,
		238, 185,
		274, 304,
		460, 396,
		151, 278,
		297, 233,
		114, 242,
		154, 909,
		469, 408,
		725, 851,
		753, 881,
		907, 746,
		644, 549,
		629, 662,
		443, 440,
		303, 753,
		312, 249,
		242, 274,
		872, 327,
		557, 205,
		910, 106,
		211, 342,
		281, 343,
		842, 876,
		331, 327,
		347, 377,
		263, 360,
		142, 623,
		492, 648,
		208, 209,
		178, 244,
		761, 732,
		329, 361,
		877, 902,
		603, 504,
		444, 378,
		394, 522,
		419, 461,
		422, 355,
		648, 134,
		568, 602,
		183, 567,
		817, 786,
		186, 344,
		601, 113,
		651, 203,
		242, 911,
		536, 120,
		436, 757,
		581, 675,
		307, 403,
		722, 562,
		170, 297,
		373, 279,
		921, 908,
		684, 515,
		881, 911,
		567, 791,
		598, 213,
		372, 274,
		143, 141,
		715, 844,
		265, 716,
		813, 208,
		796, 308,
		835, 910,
		232, 235,
		426, 838,
		757, 783,
		757, 597,
		752, 339,
		136, 109,
		356, 203,
		111, 789,
		711, 747,
		112, 907,
		878, 880,
		394, 362,
		905, 892,
		237, 915,
		302, 172,
		806, 486,
		914, 600,
		243, 112,
		519, 261,
		597, 689,
		845, 814,
		910, 853,
		141, 508,
		554, 618,
		301, 366,
		750, 817,
		879, 908,
		345, 175,
		230, 909,
		741, 521,
		391, 265,
		616, 713,
		519, 742,
		904, 846,
		337, 371,
		195, 174,
		302, 867,
		751, 440,
		205, 808,
		628, 731,
		618, 778,
		918, 204,
		559, 813,
		305, 208,
		779, 645,
		914, 333,
		692, 208,
		624, 628,
		588, 619,
		887, 437,
		716, 297,
		367, 599,
		572, 539,
		139, 175,
		252, 504,
		844, 380,
		680, 364,
		362, 107,
		783, 877,
		780, 117,
		131, 423,
		173, 239,
		746, 649,
		460, 393,
		365, 462,
		784, 750,
		594, 883,
		630, 188,
		105, 491,
		796, 137,
		124, 131,
		131, 124,
		178, 627,
		469, 560,
		811, 362,
		814, 841,
		782, 227,
		109, 356,
		807, 174,
		139, 825,
		870, 188,
		453, 811,
		643, 237,
		131, 921,
		105, 119,
		636, 905,
		582, 138,
		752, 690,
		118, 105,
		201, 455,
		750, 717,
		869, 918,
		887, 835,
		523, 490,
		752, 205,
		567, 912,
		235, 815,
		463, 590,
		457, 395,
		215, 748,
		271, 102,
		690, 655,
		715, 423,
		850, 467,
		241, 205,
		847, 369,
		771, 763,
		306, 526,
		284, 804,
		750, 592,
		845, 492,
		112, 200,
		342, 334,
		201, 284,
		663, 398,
		270, 268,
		178, 902,
		398, 557,
		589, 460,
		331, 332,
		740, 114,
		458, 715,
		142, 588,
		905, 335,
		729, 100,
		331, 520,
		498, 816,
		167, 635,
		686, 400,
		206, 337,
		779, 759,
		585, 620,
		165, 431,
		460, 653,
		494, 401,
		367, 433,
		880, 419,
		301, 274,
		323, 848,
		379, 199,
		268, 555,
		213, 260,
		715, 302,
		684, 718,
		461, 555,
		620, 586,
		591, 235,
		239, 562,
		497, 464,
		579, 215,
		524, 461,
		334, 658,
		427, 461,
		655, 365,
		462, 429,
		820, 745,
		336, 685,
		908, 501,
		304, 643,
		389, 476,
		899, 402,
		589, 342,
		590, 528,
		677, 756,
		628, 301,
		456, 175,
		403, 842,
		115, 553,
		752, 328,
		265, 656,
		252, 687,
		858, 119,
		559, 623,
		883, 241,
		823, 412,
		739, 197,
		178, 858,
		156, 783,
		495, 764,
		883, 181,
		754, 279,
		140, 365,
		912, 124,
		631, 370,
		636, 882,
		154, 272,
		367, 495,
		643, 297,
		867, 169,
		847, 924,
		119, 859,
		400, 697,
		210, 283,
		249, 730,
		237, 781,
		678, 325,
		103, 870,
		889, 816,
		303, 859,
		150, 917,
		196, 198,
		786, 698,
		618, 646,
		695, 378,
		528, 280,
		214, 820,
		592, 786,
		790, 336,
		196, 331,
		506, 311,
		209, 914,
		917, 795,
		774, 197,
		763, 148,
		309, 724,
		717, 205,
		506, 722,
		764, 463,
		794, 885,
		697, 243,
		309, 537,
		145, 495,
		311, 722,
		774, 775,
		208, 796,
		901, 102,
		883, 444,
		588, 323,
		360, 613,
		714, 199,
		560, 624,
		683, 228,
		519, 489,
		643, 323,
		309, 433,
		332, 874,
		740, 396,
		111, 750,
		755, 443,
		106, 779,
		787, 274,
		652, 131,
		400, 243,
		379, 726,
		241, 476,
		282, 273,
		823, 752,
		217, 858,
		284, 889,
		548, 648,
		335, 118,
		908, 236,
		636, 178,
		246, 560,
		635, 247,
		899, 715,
		790, 819,
		199, 428,
		774, 363,
		380, 182,
		327, 679,
		693, 692,
		179, 272,
		888, 399,
		746, 868,
		591, 115,
		282, 603,
		681, 324,
		228, 197,
		118, 849,
		619, 297,
		104, 873,
		528, 760,
		816, 918,
		395, 579,
		230, 806,
		836, 835,
		687, 187,
		612, 395,
		598, 498,
		871, 899,
		304, 572,
		284, 208,
		889, 178,
		184, 251,
		213, 283,
		691, 625,
		789, 635,
		503, 403,
		219, 154,
		122, 114,
		507, 634,
		803, 102,
		820, 656,
		120, 412,
		724, 345,
		374, 561,
		675, 227,
		814, 430,
		795, 122,
		495, 880,
		245, 475,
		360, 618,
		811, 139,
		656, 496,
		391, 393,
		785, 314,
		527, 154,
		282, 790,
		307, 691,
		508, 849,
		394, 648,
		571, 759,
		199, 803,
		908, 621,
		919, 149,
		506, 369,
		336, 759,
		329, 395,
		782, 334,
		336, 853,
		710, 524,
		163, 778,
		300, 748,
		390, 648,
		849, 889,
		854, 218,
		848, 113,
		687, 178,
		152, 119,
		163, 806,
		376, 342,
		470, 627,
		629, 437,
		838, 745,
		260, 297,
		307, 726,
		891, 912,
		923, 240,
		119, 284,
		132, 873,
		890, 217,
		778, 105,
		562, 437,
		177, 751,
		408, 660,
		697, 727,
		368, 785,
		684, 461,
		835, 903,
		198, 199,
		904, 715,
		537, 340,
		274, 624,
		259, 840,
		523, 358,
		402, 631,
		795, 241,
		623, 271,
		188, 112,
		623, 886,
		626, 662,
		759, 282,
		198, 746,
		636, 219,
		851, 824,
		493, 874,
		857, 884,
		262, 261,
		396, 868,
		411, 729,
		850, 668,
		550, 455,
		625, 472,
		881, 916,
		918, 113,
		268, 844,
		345, 308,
		389, 491,
		504, 439,
		248, 246,
		462, 141,
		688, 786,
		760, 181,
		356, 326,
		100, 170,
		232, 643,
		679, 459,
		410, 368,
		197, 588,
		184, 760,
		743, 744,
		872, 557,
		789, 276,
		694, 507,
		720, 120,
		569, 440,
		380, 753,
		497, 373,
		532, 437,
		691, 536,
		906, 900,
		889, 764,
		645, 579,
		747, 203,
		771, 299,
		784, 181,
		916, 623,
		357, 711,
		883, 853,
		553, 422,
		340, 439,
		601, 505,
		245, 664,
		473, 664,
		185, 527,
		268, 108,
		745, 165,
		466, 530,
		886, 700,
		678, 359,
		624, 282,
		508, 116,
		316, 828,
		407, 632,
		700, 860,
		131, 102,
		399, 855,
		357, 611,
		335, 880,
		880, 335,
		700, 348,
		725, 696,
		239, 668,
		283, 400,
		294, 363,
		220, 124,
		197, 264,
		438, 565,
		694, 497,
		549, 581,
		179, 655,
		663, 600,
		330, 483,
		792, 882,
		750, 558,
		233, 102,
		655, 540,
		454, 457,
		327, 356,
		495, 271,
		331, 872,
		872, 200,
		175, 156,
		247, 602,
		307, 277,
		618, 393,
		421, 453,
		878, 366,
		657, 475,
		661, 569,
		553, 550,
		243, 312,
		739, 743,
		630, 628,
		649, 677,
		103, 131,
		794, 591,
		291, 492,
		273, 186,
		899, 839,
		635, 757,
		547, 646,
		143, 923,
		788, 727,
		458, 522,
		842, 902,
		181, 668,
		112, 335,
		805, 355,
		535, 661,
		571, 283,
		259, 195,
		387, 580,
		178, 821,
		270, 111,
		133, 708,
		826, 720,
		294, 649,
		120, 698,
		371, 342,
		852, 432,
		882, 796,
		729, 345,
		721, 792,
		431, 884,
		708, 131,
		100, 461,
		695, 757,
		675, 168,
		688, 348,
		726, 341,
		377, 536,
		202, 164,
		183, 240,
		458, 581,
		325, 263,
		105, 300,
		464, 183,
		346, 690,
		244, 885,
		536, 466,
		392, 459,
		367, 783,
		742, 168,
		402, 505,
		484, 711,
		571, 241,
		103, 168,
		299, 229,
		508, 335,
		811, 748,
		181, 754,
		169, 259,
		247, 378,
		550, 390,
		589, 810,
		835, 775,
		484, 391,
		888, 314,
		634, 666,
		236, 906,
		825, 188,
		729, 722,
		795, 823,
		220, 120,
		721, 601,
		842, 620,
		216, 848,
		274, 183,
		334, 878,
		113, 116,
		410, 603,
		652, 266,
		643, 808,
		428, 100,
		347, 914,
		886, 913,
		163, 229,
		811, 779,
		166, 135,
		280, 444,
		711, 649,
		439, 472,
		775, 295,
		419, 707,
		852, 790,
		868, 739,
		667, 303,
		141, 812,
		261, 901,
		690, 439,
		892, 636,
		187, 786,
		347, 152,
		759, 633,
		202, 429,
		683, 105,
		112, 316,
		878, 237,
		920, 667,
		786, 720,
		181, 463,
		804, 589,
		281, 442,
		338, 276,
		911, 590,
		920, 720,
		273, 888,
		635, 410,
		591, 699,
		167, 355,
		547, 260,
		779, 841,
		230, 678,
		917, 792,
		151, 539,
		559, 207,
		107, 872,
		812, 716,
		611, 484,
		643, 133,
		593, 275,
		551, 485,
		114, 304,
		873, 739,
		917, 280,
		326, 296,
		523, 583,
		851, 786,
		874, 227,
		664, 373,
		227, 323,
		111, 430,
		329, 775,
		803, 867,
		315, 117,
		506, 347,
		332, 493,
		302, 188,
		805, 871,
		106, 131
	};
	return data[idx];
}
